name: Accelerated Build 6.12.23

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android16'
  KERNEL_VERSION: '6.12'
  KERNEL_NAME: 'android16-5-ga8f88ad96df3-ab13929693-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU branch (SukiSU Ultra/ReSukiSU/KernelSU Next/MKSU/KSU (official)/No built-in KSU; default: SukiSU Ultra)'
        required: true
        type: choice
        default: 'resukisu'
        options:
          - 'sukisu'
          - 'resukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
          - 'none'
      susfs_enable:
        description: 'Enable susfs (enhanced hidden-environment mount features; may slightly increase power usage; disable if upstream changes cause instability or if not needed)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: 'Enable KPM (builtin = use (Re)SukiSU built-in KPM; kpn = use standalone KPM implementation (works with any KSU/Magisk environment); keep default off if not needed)'
        required: true
        type: choice
        default: 'builtin'
        options:
          - 'false'
          - 'builtin'
          - 'kpn'
      bbr_enable:
        description: "Enable BBR (uplink optimization; usually not very useful on phones and may even be worse; false=off, true=add algorithms only, default=enable and set as default)"
        required: true
        type: choice
        default: 'true'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: 'Enable extended networking features (for ipset and apps requiring advanced netfilter/iptables kernel support)'
        required: true
        type: boolean
        default: 'true'
      adios_enable:
        description: 'Enable ADIOS I/O scheduler support (improves I/O read/write performance)'
        required: true
        type: boolean
        default: 'true'
      rekernel_enable:
        description: 'Enable Re-Kernel support (works with apps like Freezer/NoActive to improve app freezing)'
        required: true
        type: boolean
        default: 'true'
      baseband_guard:
        description: 'Enable kernel-level baseband protection (blocks all writes to non-user partitions; effectively prevents ‚Äúwipe/bricking‚Äù)'
        required: true
        type: boolean
        default: 'true'
      ccache_debug:
        description: 'Upload ccache debug logs (for debugging; keep off if not needed)'
        required: true
        type: boolean
        default: 'false'
      kernel_suffix:
        description: 'Kernel suffix (leave empty for default; do not start with a hyphen; do not include spaces or reserved characters that may break commands)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: Install dependencies + init source tree and LLVM Clang 19 toolchain
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          
          sudo apt-mark hold firefox &&
          sudo apt-mark hold libc-bin &&
          sudo apt purge man-db &&
          sudo rm -rf /var/lib/man-db/auto-update &&
          sudo apt update &&
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev libdw-dev &
          
          # Use the latest ccache v4.12.2 (Ubuntu repo version is not the latest)
          wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/lib/ccache-x86-64 -O ccache &&
          sudo cp -f ./ccache /usr/bin/ccache &&
          sudo chmod +x /usr/bin/ccache &&
          rm -f ./ccache &
          
          echo "Cloning kernel source..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/android_kernel_common_oneplus_sm8850/archive/refs/heads/oneplus/sm8850_v_16.0.0_oneplus_15.zip -o common.zip && 
          unzip -q common.zip && 
          mv "android_kernel_common_oneplus_sm8850-oneplus-sm8850_v_16.0.0_oneplus_15" common &&
          rm -rf common.zip &
          
          echo "Downloading LLVM Clang 19 toolchain..." &&
          mkdir -p clang19 &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/clang-r536225.zip -o clang.zip &&
          unzip -q clang.zip -d clang19 &&
          rm -rf clang.zip &
          
          echo "Downloading Rust 1.82.0 toolchain..." &&
          mkdir -p rust &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/rust.zip -o rust.zip &&
          unzip -q rust.zip -d rust &&
          rm -rf clang.zip &
          
          echo "Downloading build tools..." &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/build-tools.zip -o build-tools.zip &&
          unzip -q build-tools.zip &&
          rm -rf build-tools.zip &
          
          wait
          echo "Kernel source and LLVM Clang 19 toolchain initialization complete!"
          echo "Removing -dirty suffix..."
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done

      - name: Configure ccache directory
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_6.12.23" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV
          echo "Current disk space:"
          df -h
          echo "Current kernel build version: 6.12.23"

      - name: Restore ccache for this kernel version
        uses: actions/cache@v4
        id: ccache-restore
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-neov5-6.12.23-${{ runner.os }}-main
          restore-keys: |
            ccache-neov5-6.12.23-${{ runner.os }}-
            ccache-neov5-6.12.23-
      
      - name: Initialize and configure ccache
        run: |
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_NOHARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"
          
          mkdir -p "$CCACHE_DIR"
          
          echo "Setting ccache max size to: $CCACHE_MAXSIZE"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true
          
          echo "Initial ccache stats:"
          ccache -s
          
          if [ "${{ steps.ccache-restore.outputs.cache-hit }}" == 'true' ]; then
            echo "ccache cache-hit details:"
            ccache -sv
          fi

      - name: Add KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            echo "Configuring SukiSU Ultra..."
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s builtin
            cd ./KernelSU
            GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
            echo "Current commit hash: $GIT_COMMIT_HASH"
            export KSU_VERSION=$KSU_VERSION
            for i in {1..3}; do
              KSU_API_VERSION=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/builtin/kernel/Kbuild" | \
                grep -m1 "KSU_VERSION_API :=" | \
                awk -F'= ' '{print $2}' | \
                tr -d '[:space:]')
              [ -n "$KSU_API_VERSION" ] && break || sleep 1
            done
            [ -z "$KSU_API_VERSION" ] && KSU_API_VERSION="3.1.7"
            echo "KSU_API_VERSION=$KSU_API_VERSION" >> $GITHUB_ENV
            VERSION_DEFINITIONS=$'define get_ksu_version_full\nv\\$1-'"$GIT_COMMIT_HASH"$'@‚ö°Ultra‚ö°\nendef\n\nKSU_VERSION_API := '"$KSU_API_VERSION"$'\nKSU_VERSION_FULL := v'"$KSU_API_VERSION"$'-'"$GIT_COMMIT_HASH"$'@‚ö°Ultra‚ö°'
            sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild
            sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild
            sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild
            awk -v def="$VERSION_DEFINITIONS" '
              /REPO_OWNER :=/ {print; print def; inserted=1; next}
              1
              END {if (!inserted) print def}
            ' kernel/Kbuild > kernel/Kbuild.tmp && mv kernel/Kbuild.tmp kernel/Kbuild
            KSU_VERSION=$(expr $(git rev-list --count main) + 37185 2>/dev/null || echo 114514)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            grep -A10 "REPO_OWNER" kernel/Kbuild
            grep "KSU_VERSION_FULL" kernel/Kbuild
            echo "SukiSU version: v${KSU_API_VERSION}-${GIT_COMMIT_HASH}@‚ö°Ultra‚ö°"
          elif [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]]; then
            echo "Configuring ReSukiSU..."
            curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/refs/heads/main/kernel/setup.sh" | bash -s main
            echo 'CONFIG_KSU_FULL_NAME_FORMAT="%TAG_NAME%-%COMMIT_SHA%@‚ö°Ultra‚ö°"' >> ./common/arch/arm64/configs/gki_defconfig
            cd ./KernelSU
            KSU_VERSION=$(expr $(git rev-list --count main) + 30700 2>/dev/null || echo 114514)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            echo "Configuring KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/dev-susfs/kernel/setup.sh" | bash -s dev-susfs
            cd KernelSU-Next
            rm -rf .git
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=dev&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            sed -i "s/KSU_VERSION_FALLBACK := 1/KSU_VERSION_FALLBACK := $KSU_VERSION/g" kernel/Kbuild
            KSU_GIT_TAG=$(curl -sL "https://api.github.com/repos/KernelSU-Next/KernelSU-Next/tags" | grep -o '"name": *"[^"]*"' | head -n 1 | sed 's/"name": "//;s/"//')
            sed -i "s/KSU_VERSION_TAG_FALLBACK := v0.0.1/KSU_VERSION_TAG_FALLBACK := $KSU_GIT_TAG/g" kernel/Kbuild
            cd ../common/drivers/kernelsu
            wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/other_patch/apk_sign.patch
            patch -p2 -N -F 3 < apk_sign.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
            echo "Configuring MKSU (5ec1cff/KernelSU)..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            echo "Configuring official KernelSU (tiann/KernelSU)..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
          else
            echo "No built-in KernelSU selected; skipping KernelSU setup..."
          fi

      - name: Apply KernelSU & SUSFS patches
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            echo "Adding SukiSU Ultra patches..."
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
            cd ./common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]]; then
            echo "Adding ReSukiSU patches..."
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
            cd ./common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
            sed -i 's|vma = find_vma(mm|struct vm_area_struct *&|' ./fs/proc/task_mmu.c
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            echo "Adding KernelSU Next patches..."
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
            cd ./common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
            echo "Adding patches for MKSU (5ec1cff/KernelSU)..."
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./KernelSU/
            PATCH_FILE="./KernelSU/10_enable_susfs_for_ksu.patch"
            if [ -f "$PATCH_FILE" ]; then
              if grep -q "a/kernel/Makefile" "$PATCH_FILE"; then
                echo "Detected legacy Makefile patch content; applying fix..."
                sed -i 's|kernel/Makefile|kernel/Kbuild|g' "$PATCH_FILE"
                sed -i 's|^@@ .* format:.*|@@ -94,4 +94,13 @@|' "$PATCH_FILE"
                sed -i 's|.*check-format:.*| ccflags-y += -Wno-strict-prototypes -Wno-int-conversion -Wno-gcc-compat -Wno-missing-prototypes|' "$PATCH_FILE"
                sed -i 's|.*clang-format --dry-run.*| ccflags-y += -Wno-declaration-after-statement -Wno-unused-function -Wno-unused-variable|' "$PATCH_FILE"
                echo "Patch fix complete!"
              else
                echo "Patch already fixed to Kbuild or not matching; skipping..."
              fi
            else
              echo "KSU patch not found!"
              exit 1
            fi
            cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
            cd ./KernelSU
            patch -p1 < 10_enable_susfs_for_ksu.patch || true
            wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/other_patch/mksu_supercalls.patch
            patch -p1 < mksu_supercalls.patch || true
            cd ../common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            echo "Adding patches for official KernelSU (tiann/KernelSU)..."
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./KernelSU/
            PATCH_FILE="./KernelSU/10_enable_susfs_for_ksu.patch"
            if [ -f "$PATCH_FILE" ]; then
              if grep -q "a/kernel/Makefile" "$PATCH_FILE"; then
                echo "Detected legacy Makefile patch content; applying fix..."
                sed -i 's|kernel/Makefile|kernel/Kbuild|g' "$PATCH_FILE"
                sed -i 's|^@@ .* format:.*|@@ -94,4 +94,13 @@|' "$PATCH_FILE"
                sed -i 's|.*check-format:.*| ccflags-y += -Wno-strict-prototypes -Wno-int-conversion -Wno-gcc-compat -Wno-missing-prototypes|' "$PATCH_FILE"
                sed -i 's|.*clang-format --dry-run.*| ccflags-y += -Wno-declaration-after-statement -Wno-unused-function -Wno-unused-variable|' "$PATCH_FILE"
                echo "Patch fix complete!"
              else
                echo "Patch already fixed to Kbuild or not matching; skipping..."
              fi
            else
              echo "KSU patch not found!"
              exit 1
            fi
            cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
            cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
            cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
            cd ./KernelSU
            patch -p1 < 10_enable_susfs_for_ksu.patch || true
            cd ../common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          else
            echo "No built-in KernelSU selected; skipping susfs setup..."
          fi

      - name: Add SUSFS config options
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          echo "CONFIG_KSU_SUSFS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> ./common/arch/arm64/configs/gki_defconfig
          
      - name: Add KSU & other config options
        run: |
          cd kernel_workspace
          echo "CONFIG_KSU=y" >> ./common/arch/arm64/configs/gki_defconfig
          if [[ ${{ github.event.inputs.kpm_enable }} == 'builtin' && ( "${{ github.event.inputs.ksu_type }}" == "sukisu" || "${{ github.event.inputs.ksu_type }}" == "resukisu" ) ]]; then
            echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          if [[ "${{ github.event.inputs.susfs_enable }}" == "false" ]]; then
            echo "CONFIG_KSU_SUSFS=n" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          echo "CONFIG_TMPFS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./common/arch/arm64/configs/gki_defconfig          
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_OPTIMIZE_INLINING=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_KERNEL=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_INFO=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_INFO_DWARF4=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_LOCK_DEBUGGING=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_MUTEXES=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_SPINLOCK=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEBUG_ATOMIC_SLEEP=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_GDB_SCRIPTS=n" >> ./common/arch/arm64/configs/gki_defconfig
          
          sed -i 's/check_defconfig//' ./common/build.config.gki
          echo "CONFIG_HEADERS_INSTALL=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_RUST=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_ANDROID_BINDER_IPC_RUST=m" >> ./common/arch/arm64/configs/gki_defconfig
          
      - name: Enable enhanced networking features
        if: inputs.better_net
        run: |
          cd kernel_workspace
          echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_NETFILTER_XT_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_MAX=65534" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IP=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPMARK=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_IPMAC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_MAC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET_LIST_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP6_NF_NAT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> ./common/arch/arm64/configs/gki_defconfig
          cd common
          wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/other_patch/config.patch
          patch -p1 -F 3 < config.patch || true

      - name: Add BBR and other congestion control algorithms
        run: |
          if [[ "${{ github.event.inputs.bbr_enable }}" != "false" ]]; then
            echo "Adding BBR and other congestion control algorithms..."
            cd kernel_workspace
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BBR=y" >> ./common/arch/arm64/configs/gki_defconfig
            if [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
              echo "Setting BBR as the default congestion control algorithm..."
              echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> ./common/arch/arm64/configs/gki_defconfig
            else
              echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> ./common/arch/arm64/configs/gki_defconfig
            fi
          fi

      - name: Enable ADIOS I/O scheduler
        if: inputs.adios_enable
        run: |
          echo "Enabling ADIOS I/O scheduler (combines deadline-priority scheduling with self-learning adaptive latency control to reduce I/O latency)..."
          cd kernel_workspace
          echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> ./common/arch/arm64/configs/gki_defconfig

      - name: Enable Re-Kernel support
        if: inputs.rekernel_enable
        run: |
          echo "Enabling Re-Kernel support"
          cd kernel_workspace
          echo "CONFIG_REKERNEL=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_REKERNEL_NETWORK=y" >> ./common/arch/arm64/configs/gki_defconfig

      - name: Enable kernel-level baseband protection
        if: inputs.baseband_guard
        run: |
          echo "Enabling kernel-level baseband protection support..."
          cd kernel_workspace
          echo "CONFIG_BBG=y" >> ./common/arch/arm64/configs/gki_defconfig
          cd ./common
          curl -sSL https://github.com/cctv18/Baseband-guard/raw/master/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig

      - name: Set build name
        run: |
          cd kernel_workspace
          echo "Replacing kernel version suffix..."
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            echo "Kernel version suffix: ${{ github.event.inputs.kernel_suffix }}"
            for f in ./common/scripts/setlocalversion; do
              sed -i "\$s|echo \"\\\$res\"|echo \"-${{ github.event.inputs.kernel_suffix }}\"|" "$f"
            done
            sudo sed -i 's/-4k/-${{ github.event.inputs.KERNEL_SUFFIX }}/g' ./common/arch/arm64/configs/gki_defconfig
          else
            echo "Kernel version suffix: ${{ env.KERNEL_NAME }}"
            for f in ./common/scripts/setlocalversion; do
              sed -i "\$s|echo \"\\\$res\"|echo \"-${{ env.KERNEL_NAME }}\"|" "$f"
            done
            sudo sed -i 's/-4k/-${{ env.KERNEL_NAME }}/g' ./common/arch/arm64/configs/gki_defconfig
          fi
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          echo "CONFIG_LOCALVERSION_AUTO=n" >> ./common/arch/arm64/configs/gki_defconfig

      - name: Set kernel build timestamp
        shell: bash
        run: |
          set -euo pipefail
          unset SOURCE_DATE_EPOCH || true

          # This is what shows in uname -v / uname -a after "#1 SMP PREEMPT"
          TS="$(TZ='Asia/Shanghai' date '+%a %b %e %T %Z %Y')"

          echo "KBUILD_BUILD_TIMESTAMP=$TS" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_VERSION=1" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_USER=github" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_HOST=actions" >> "$GITHUB_ENV"

          echo "Using KBUILD_BUILD_TIMESTAMP: $TS"

      - name: Build kernel
        run: |
          WORKDIR="$(pwd)"
          export PATH="/usr/lib/ccache:$PATH"
          export PATH="$WORKDIR/kernel_workspace/clang19/bin:$PATH"
          export PATH="$WORKDIR/kernel_workspace/build-tools/bin:$PATH"
          export PATH="$WORKDIR/kernel_workspace/rust/bin:$PATH"
      
          # ---- Fix uname build time (avoid 1970) ----
          unset SOURCE_DATE_EPOCH || true
          export KBUILD_BUILD_TIMESTAMP="$(TZ='Asia/Shanghai' date '+%a %b %e %T %Z %Y')"
          export KBUILD_BUILD_VERSION=1
          export KBUILD_BUILD_USER=github
          export KBUILD_BUILD_HOST=actions
          echo "KBUILD_BUILD_TIMESTAMP=$KBUILD_BUILD_TIMESTAMP"
      
          export CLANG_DIR="$WORKDIR/kernel_workspace/clang19/bin"
          CLANG_VERSION="$($CLANG_DIR/clang --version | head -n 1)"
          LLD_VERSION="$($CLANG_DIR/ld.lld --version | head -n 1)"
          RUSTC_VERSION="$(rustc -V 2>/dev/null | head -n1)"
          BINDGEN_VERSION="$(bindgen --version 2>/dev/null | head -n1)"
          echo "Compiler info:"
          echo "Clang version: $CLANG_VERSION"
          echo "LLD version: $LLD_VERSION"
          echo "Rustc version: $RUSTC_VERSION"
          echo "Bindgen version: $BINDGEN_VERSION"
          pahole_version=$(pahole --version 2>/dev/null | head -n1); [ -z "$pahole_version" ] && echo "pahole: not installed" || echo "pahole: $pahole_version"
      
          export CCACHE_LOGFILE="${{ github.workspace }}/kernel_workspace/ccache.log"
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_NOHARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="3G"
          echo "sloppiness = file_stat_matches,include_file_ctime,include_file_mtime,pch_defines,file_macro,time_macros" >> "$CCACHE_DIR/ccache.conf"
      
          cd kernel_workspace/common
          wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/lib/libfakestat.so
          wget https://github.com/cctv18/oppo_oplus_realme_sm8850/raw/refs/heads/main/lib/libfaketimeMT.so
          chmod 777 ./*.so
          export FAKESTAT="2025-05-25 12:00:00"
          export FAKETIME="@2025-05-25 13:00:00"
          echo "FAKESTAT=$FAKESTAT" >> $GITHUB_ENV
          echo "FAKETIME=$FAKETIME" >> $GITHUB_ENV
          SO_DIR=$(pwd)
          export PRELOAD_LIBS="$SO_DIR/libfakestat.so $SO_DIR/libfaketimeMT.so"
          export REAL_CLANG_PATH="$WORKDIR/kernel_workspace/clang19/bin/clang"
      
          echo '#!/bin/bash' > cc-wrapper
          echo 'export LD_PRELOAD="'"$PRELOAD_LIBS"'"' >> cc-wrapper
          echo 'export FAKESTAT="'"$FAKESTAT"'"' >> cc-wrapper
          echo 'export FAKETIME="'"$FAKETIME"'"' >> cc-wrapper
          echo 'ccache '"$REAL_CLANG_PATH"' "$@"' >> cc-wrapper
      
          echo '#!/bin/bash' > ld-wrapper
          echo 'export LD_PRELOAD="'"$PRELOAD_LIBS"'"' >> ld-wrapper
          echo 'export FAKESTAT="'"$FAKESTAT"'"' >> ld-wrapper
          echo 'export FAKETIME="'"$FAKETIME"'"' >> ld-wrapper
          echo 'ld.lld "$@"' >> ld-wrapper
      
          echo "--- [Wrapper Test] Creating a generic time-hook test script ---"
          echo '#!/bin/bash' > test-wrapper.sh
          echo 'export LD_PRELOAD="'"$PRELOAD_LIBS"'"' >> test-wrapper.sh
          echo 'export FAKESTAT="'"$FAKESTAT"'"' >> test-wrapper.sh
          echo 'export FAKETIME="'"$FAKETIME"'"' >> test-wrapper.sh
          echo 'echo ">>> Wrapper internal env check done."' >> test-wrapper.sh
          echo 'exec "$@"' >> test-wrapper.sh
          chmod +x test-wrapper.sh
      
          echo "--- [Wrapper Test] Testing (date) ---"
          ./test-wrapper.sh date
          echo "--- [Wrapper Test] Testing (stat) ---"
          ./test-wrapper.sh stat ./Makefile
          echo "--- [Wrapper Test] Done ---"
          chmod +x cc-wrapper ld-wrapper
      
          echo "--- Pre-build environment time: $(LD_PRELOAD=$PRELOAD_LIBS date) ---"
          echo "--- Pre-build file timestamps: ---"
          LD_PRELOAD=$PRELOAD_LIBS stat ./Makefile
      
          COMMON_REAL_PATH=$(pwd -P)
          ROOT_REAL_PATH=$(dirname "$COMMON_REAL_PATH")
          KCFLAGS+=" -fdebug-prefix-map=$ROOT_REAL_PATH=."
          KCFLAGS+=" -fmacro-prefix-map=$ROOT_REAL_PATH=."
          KCFLAGS+=" -ffile-prefix-map=$ROOT_REAL_PATH=."
          export RUSTC="rustc"
          export BINDGEN="bindgen"
          export CC="clang"
          export LIBCLANG_PATH="$WORKDIR/kernel_workspace/clang19/lib"
          KCFLAGS+=" -no-canonical-prefixes"
          KCFLAGS+=" -O2"
          KCFLAGS+=" -pipe"
          KCFLAGS+=" -Wno-error"
          KCFLAGS+=" -fno-stack-protector"
          KCFLAGS+=" -D__ANDROID_COMMON_KERNEL__"
          export KCFLAGS
          export HOSTCC=clang
          export LD="ld.lld"
          export HOSTLD=ld.lld
          export LLVM=1 LLVM_IAS=1
          export ARCH=arm64 SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm AS=clang READELF=llvm-readelf
          export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump OBJSIZE=llvm-size STRIP=llvm-strip
          source "./_setup_env.sh" 2>/dev/null || true
      
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
      
          make -j"$(nproc --all)" LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            CC="clang" LD="ld.lld" OBJCOPY="llvm-objcopy" O=out gki_defconfig
      
          # Disable selected KUnit-related configs + force ThinLTO (best-effort)
          OUT=out
          disable_list=(
            CONFIG_REGMAP_KUNIT
            CONFIG_INPUT_KUNIT_TEST
            CONFIG_SND_SOC_TOPOLOGY_KUNIT_TEST
            CONFIG_SND_SOC_UTILS_KUNIT_TEST
            CONFIG_HID_KUNIT_TEST
            CONFIG_RTC_LIB_KUNIT_TEST
            CONFIG_CLK_KUNIT_TEST
            CONFIG_CLK_GATE_KUNIT_TEST
            CONFIG_IIO_FORMAT_KUNIT_TEST
            CONFIG_EXT4_KUNIT_TESTS
            CONFIG_FAT_KUNIT_TEST
          )
      
          if [ -x "scripts/config" ] && [ -f "$OUT/.config" ]; then
            # 1) Disable KUnit bits
            for sym in "${disable_list[@]}"; do
              scripts/config --file "$OUT/.config" -d "$sym" 2>/dev/null || true
            done
      
            # 2) Force ThinLTO
            scripts/config --file "$OUT/.config" -e LTO -e LTO_CLANG 2>/dev/null || true
            scripts/config --file "$OUT/.config" -e LTO_CLANG_THIN -d LTO_CLANG_FULL -d LTO_NONE 2>/dev/null || true
            scripts/config --file "$OUT/.config" -e THINLTO 2>/dev/null || true
      
            # 3) Re-resolve Kconfig deps
            make O="$OUT" olddefconfig >/dev/null 2>&1 || true
      
            echo "---- LTO config ----"
            grep -E '^(CONFIG_LTO|CONFIG_LTO_CLANG|CONFIG_THINLTO|CONFIG_LTO_CLANG_THIN|CONFIG_LTO_CLANG_FULL|CONFIG_LTO_NONE)=' "$OUT/.config" || true
          else
            echo "scripts/config or $OUT/.config not found; skipping config edits"
          fi
      
          export CC="$(pwd)/cc-wrapper"
          export LD="$(pwd)/ld-wrapper"
          make -j"$(nproc --all)" LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            CC="$(pwd)/cc-wrapper" LD="$(pwd)/ld-wrapper" OBJCOPY="llvm-objcopy" O=out Image
      
          echo "--- Post-build environment time: $(LD_PRELOAD=$PRELOAD_LIBS date) ---"
          echo "--- Post-build file timestamps: ---"
          LD_PRELOAD=$PRELOAD_LIBS stat ./Makefile
      
          # Quick verification: what uname -v will show
          echo "---- compile.h (timestamp baked into uname) ----"
          cat out/include/generated/compile.h | sed -n '1,120p' || true
      
          echo "Kernel build complete!"
          if [[ "${{ github.event.inputs.ccache_debug }}" == "true" ]]; then
            echo "Packing ccache logs and debug info..."
            cd ..
            cp ./common/out/vmlinux.symvers ./vmlinux.symvers
            cp ./common/out/.config ./config
            zip -r9 debug.zip ccache.log config vmlinux.symvers
          fi
          echo "ccache stats:"
          ccache -s
          echo "Disk space after build:"
          df -h
         
      - name: Apply KPM and patch the kernel
        run: |
          if [[ ${{ github.event.inputs.kpm_enable }} == 'builtin' && ( "${{ github.event.inputs.ksu_type }}" == "sukisu" || "${{ github.event.inputs.ksu_type }}" == "resukisu" ) ]]; then
            echo "Applying KPM and patching the kernel..."
            cd kernel_workspace/common/out/arch/arm64/boot
            curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/latest/download/patch_linux
            chmod +x patch_linux
            ./patch_linux
            rm -f Image
            mv oImage Image
          fi
          
      - name: Clone AnyKernel3 and package
        run: |
          cd kernel_workspace
          git clone https://github.com/bouteillepleine/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          cp ../common/out/arch/arm64/boot/Image ./Image
          if [[ ! -f ./Image ]]; then
            echo "Kernel Image not found; build may have failed"
            exit 1
          fi
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            KSU_TYPENAME="SukiSU"
          elif [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]]; then
            KSU_TYPENAME="ReSukiSU"
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            KSU_TYPENAME="KSUNext"
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
            KSU_TYPENAME="MKSU"
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            KSU_TYPENAME="KSU"
          else
            KSU_TYPENAME="none"
          fi
          if [[ ${{ github.event.inputs.kpm_enable }} == 'kpn' ]]; then
            wget https://github.com/cctv18/KPatch-Next/releases/latest/download/kpn.zip
          fi
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            zip -r ../AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ github.event.inputs.kernel_suffix }}.zip ./*
          else
            zip -r ../AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ env.KERNEL_NAME }}.zip ./*
          fi

      - name: Upload ccache debug logs
        if: always() && inputs.ccache_debug
        uses: actions/upload-artifact@v4
        with:
          name: ccache-debug-log
          path: ${{ github.workspace }}/kernel_workspace/debug.zip

      - name: Upload ZIP artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ${{ github.workspace }}/kernel_workspace/AnyKernel*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
      
    steps:
      - name: Download ZIP artifacts
        uses: actions/download-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ./release_zips

      - name: Set environment variables
        run: |
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            FULL_VERSION=${{ format('{0}.23-{1}', env.KERNEL_VERSION, github.event.inputs.kernel_suffix) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          else
            FULL_VERSION=${{ format('{0}.23-{1}', env.KERNEL_VERSION, env.KERNEL_NAME) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          fi
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="OPPO+OPlus+Realme-A15-build"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            KSU_TYPENAME="SukiSU Ultra"
          elif [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]]; then
            KSU_TYPENAME="ReSukiSU"
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            KSU_TYPENAME="KernelSU Next"
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]]; then
            KSU_TYPENAME="MKSU"
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            KSU_TYPENAME="KSU"
          else
            KSU_TYPENAME="No built-in KSU"
          fi
          echo "KSU_TYPENAME=$KSU_TYPENAME" >> $GITHUB_ENV
         
      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }}-${{ env.FULL_VERSION }}"
          body: |
            ### üì± OPPO+OnePlus+Realme ${{ env.KSU_TYPENAME }} sm8850 universal kernel | Build info
            - Kernel version: ${{ env.FULL_VERSION }}
            - Build time: ${{ env.TIME_FORM }}
            - Devices: OPPO/OnePlus/Realme Snapdragon 8E Gen5 universal 6.12.23 kernel (based on official OnePlus 15 6.12.23 sources)
            - KSU branch: ${{ env.KSU_TYPENAME }}
            - susfs support: ${{ github.event.inputs.susfs_enable }}
            - KPM support: ${{ github.event.inputs.kpm_enable }}
            - Enhanced networking: ${{ github.event.inputs.better_net }}
            - BBR and other congestion control algorithms: ${{ github.event.inputs.bbr_enable }}
            - ADIOS I/O scheduler support: ${{ github.event.inputs.adios_enable }}
            - Re-Kernel support: ${{ github.event.inputs.rekernel_enable }}
            - Kernel-level baseband protection: ${{ github.event.inputs.baseband_guard }}
            - SukiSU Ultra Manager: [SukiSU-Ultra](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)
            - KernelSU Next Manager: [KernelSU-Next](https://github.com/KernelSU-Next/KernelSU-Next/releases)
            - MKSU Manager: [Magic-KernelSU](https://github.com/5ec1cff/KernelSU/actions)
            - Official KernelSU Manager: [KernelSU](https://github.com/tiann/KernelSU/releases)
            ### ‚è´Ô∏è Updates:
            - Updated ${{ env.KSU_TYPENAME }} to latest (${{ needs.build.outputs.ksuver }})
            - (Reserved)
            ### üìã Installation Guide
            1. If you have a custom recovery installed (e.g., TWRP), download the AnyKernel ZIP for your device, boot into recovery, flash the ZIP, then reboot.
            2. If your phone already has root access, install [HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases), flash the AnyKernel ZIP in the app, then reboot.
            3. If you previously flashed a SukiSU Ultra kernel and your SukiSU Ultra Manager is up to date, you can flash the AnyKernel ZIP directly in the manager and reboot.
            4. KernelSU upstream updated the ‚Äúmeta module‚Äù mechanism. The latest KSU managers (all branches except KernelSU Next) require a metamodule to mount modules properly. Current metamodules include: [meta overlayfs](https://github.com/KernelSU-Modules-Repo/meta-overlayfs), [mountify](https://github.com/backslashxx/mountify), [meta magicmount](https://github.com/7a72/meta-magic_mount/), [meta magicmount rs](https://github.com/Tools-cx-app/meta-magic_mount/), [hybrid mount](https://github.com/YuzakiKokuban/meta-hybrid_mount), etc. If this is your first time using KSU or you just upgraded from an older manager, install one metamodule first so other mount-related modules can work correctly.
            5. KernelPatch Next (KPN) is a standalone KPM implementation independent of KSU. It can run on any KSU/Magisk environment (not supported on APatch) and cannot be used together with built-in KPM from (Re)SukiSU. Make sure your kernel has no built-in KPM implementation/patch before using KPN. Because KPN requires setting a superkey, this workflow does not auto-patch the kernel with a unified superkey for safety. After flashing, the first time you run the module you must patch the kernel manually.
            #### ‚ö†Ô∏è Flashing kernels is risky. To avoid bricking your phone, back up critical boot partitions (e.g., boot) with tools like [KernelFlasher](https://github.com/capntrips/KernelFlasher) before flashing! ‚ö†Ô∏è
          draft: false
          prerelease: false
          files: |
            release_zips/AnyKernel3_*.zip
